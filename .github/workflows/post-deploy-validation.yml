name: Post-Deploy Validation

on:
  workflow_run:
    workflows: ["Deploy", "Deploy Canary"]
    types: [completed]
    branches: [staging, production]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to validate'
        type: choice
        options: [staging, production]
        required: true

permissions:
  contents: read
  issues: write

jobs:
  determine-environment:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    outputs:
      environment: ${{ steps.env.outputs.name }}
      url: ${{ steps.env.outputs.url }}
    steps:
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ inputs.environment }}"
          else
            ENV="${{ github.event.workflow_run.head_branch }}"
          fi

          case "$ENV" in
            staging)
              echo "name=staging" >> $GITHUB_OUTPUT
              echo "url=https://staging-api.bless2n.app" >> $GITHUB_OUTPUT
              ;;
            production)
              echo "name=production" >> $GITHUB_OUTPUT
              echo "url=https://api.bless2n.app" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "name=staging" >> $GITHUB_OUTPUT
              echo "url=https://staging-api.bless2n.app" >> $GITHUB_OUTPUT
              ;;
          esac

  smoke-tests:
    name: Smoke tests
    needs: determine-environment
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v5

      # Wait for deployment to settle
      - name: Wait for deployment
        run: sleep 30

      # Health checks
      - name: Health check
        run: |
          MAX_RETRIES=5
          RETRY=0

          while [ $RETRY -lt $MAX_RETRIES ]; do
            if curl -f -s ${{ needs.determine-environment.outputs.url }}/health; then
              echo "✅ Health check passed"
              exit 0
            fi

            RETRY=$((RETRY + 1))
            echo "Retry $RETRY/$MAX_RETRIES..."
            sleep 10
          done

          echo "❌ Health check failed after $MAX_RETRIES retries"
          exit 1

      # Critical path tests
      - name: Test critical paths
        run: |
          BASE_URL="${{ needs.determine-environment.outputs.url }}"

          # Test menu endpoint
          echo "Testing menu endpoint..."
          curl -f -s "$BASE_URL/v1/menu" > /dev/null || exit 1

          # Test categories endpoint
          echo "Testing categories endpoint..."
          curl -f -s "$BASE_URL/v1/categories" > /dev/null || exit 1

          echo "✅ Critical paths validated"

  integration-tests:
    name: Integration tests
    needs: [determine-environment, smoke-tests]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: bfs-backend

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Run integration tests
        working-directory: bfs-backend/test/integration
        env:
          API_BASE_URL: ${{ needs.determine-environment.outputs.url }}
        run: |
          if [ -d "." ]; then
            go test -v -timeout 15m ./... || echo "No integration tests found"
          else
            echo "No integration tests directory, skipping"
          fi
        continue-on-error: true

  performance-tests:
    name: Performance tests
    needs: [determine-environment, smoke-tests]
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v5

      - name: Install k6
        run: |
          curl https://github.com/grafana/k6/releases/download/v0.49.0/k6-v0.49.0-linux-amd64.tar.gz -L | tar xvz
          sudo mv k6-v0.49.0-linux-amd64/k6 /usr/local/bin/

      - name: Run basic load test
        run: |
          cat > load-test.js << 'EOF'
          import http from 'k6/http';
          import { check, sleep } from 'k6';

          export const options = {
            stages: [
              { duration: '30s', target: 10 },
              { duration: '1m', target: 10 },
              { duration: '30s', target: 0 },
            ],
            thresholds: {
              http_req_duration: ['p(95)<1000'],
              http_req_failed: ['rate<0.05'],
            },
          };

          export default function () {
            const res = http.get('${{ needs.determine-environment.outputs.url }}/health');
            check(res, {
              'status is 200': (r) => r.status === 200,
            });
            sleep(1);
          }
          EOF

          k6 run load-test.js || echo "⚠️  Performance test had issues but continuing"
        continue-on-error: true

  validation-report:
    name: Validation report
    runs-on: ubuntu-latest
    needs: [determine-environment, smoke-tests, integration-tests, performance-tests]
    if: always()

    steps:
      - name: Generate validation report
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              smoke: '${{ needs.smoke-tests.result }}',
              integration: '${{ needs.integration-tests.result }}',
              performance: '${{ needs.performance-tests.result }}'
            };

            const formatResult = (result) => {
              if (result === 'success') return '✅';
              if (result === 'skipped') return '⏭️';
              if (result === 'failure') return '❌';
              return '❓';
            };

            const allPassed = Object.values(results).every(r => r === 'success' || r === 'skipped');
            const emoji = allPassed ? '✅' : '❌';

            const body = `## ${emoji} Post-Deploy Validation Report

            | Test Suite | Result |
            |------------|--------|
            | Smoke Tests | ${formatResult(results.smoke)} ${results.smoke} |
            | Integration Tests | ${formatResult(results.integration)} ${results.integration} |
            | Performance Tests | ${formatResult(results.performance)} ${results.performance} |

            **Environment**: ${{ needs.determine-environment.outputs.environment }}
            **URL**: ${{ needs.determine-environment.outputs.url }}

            ${allPassed ? '✅ All validation checks passed!' : '⚠️ Some validation checks did not pass. Please review the details.'}

            [View workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            `;

            core.summary.addRaw(body);
            await core.summary.write();

            if (!allPassed && '${{ needs.determine-environment.outputs.environment }}' === 'production') {
              // Create issue for production failures
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '⚠️ Post-Deploy Validation Issues (${{ needs.determine-environment.outputs.environment }})',
                body: body,
                labels: ['deployment', 'validation', '${{ needs.determine-environment.outputs.environment }}']
              });
            }
