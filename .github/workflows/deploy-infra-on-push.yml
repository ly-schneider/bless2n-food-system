name: Deploy Infra via TFC (on build)

on:
  workflow_run:
    workflows: ["Build & Push Images"]
    types: [completed]
  push:
    branches: [staging, production]
    paths: ['.github/workflows/deploy-infra-on-push.yml']

permissions:
  contents: read

concurrency:
  group: deploy-infra-${{ github.event.workflow_run.head_branch || github.ref_name }}
  cancel-in-progress: false

jobs:
  from-build:
    if: >
      ${{
        github.event_name == 'workflow_run' &&
        github.event.workflow_run.conclusion == 'success' &&
        (github.event.workflow_run.head_branch == 'staging' || github.event.workflow_run.head_branch == 'production')
      }}
    uses: ./.github/workflows/reusable-tfc-apply.yml
    secrets: inherit
    with:
      target_branch: ${{ github.event.workflow_run.head_branch }}
      image_tag: ${{ github.event.workflow_run.head_branch }}
      revision_suffix: ${{ github.event.workflow_run.head_sha }}
      wait_for_completion: ${{ github.event.workflow_run.head_branch == 'staging' }}

  on-self-change:
    if: ${{ github.event_name == 'push' }}
    uses: ./.github/workflows/reusable-tfc-apply.yml
    secrets: inherit
    with:
      target_branch: ${{ github.ref_name }}
      image_tag: ${{ github.ref_name }}
      revision_suffix: ${{ github.sha }}
      wait_for_completion: ${{ github.ref_name == 'staging' }}
