name: CI

on:
  pull_request:
    branches: [ production, staging ]
  push:
    branches: [ production, staging ]

jobs:
  format:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
        with:
          version: 9
      - uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: bfs-web-app/pnpm-lock.yaml
      - name: Web format check
        working-directory: bfs-web-app
        run: |
          pnpm install --frozen-lockfile
          pnpm run prettier

      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd
        with:
          terraform_version: 1.13.3
      - name: Terraform fmt check
        working-directory: bfs-cloud
        run: terraform fmt -check -recursive

  lint:
    name: Lint Check
    runs-on: ubuntu-latest
    needs: format
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
        with:
          version: 9
      - uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: bfs-web-app/pnpm-lock.yaml
      - name: Web lint
        working-directory: bfs-web-app
        run: |
          pnpm install --frozen-lockfile
          pnpm run lint

      - uses: actions/setup-go@0a12ed9d6a96ab950c8f026ed9f722fe0da7ef32
        with:
          go-version: '1.25'
      - name: Go lint
        uses: golangci/golangci-lint-action@4afd733a84b1f43292c63897423277bb7f4313a9
        with:
          version: latest
          working-directory: bfs-backend

      - name: Set up Java for Android
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165
        with:
          distribution: temurin
          java-version: '21'
      - name: Set up Android SDK
        uses: android-actions/setup-android@9fc6c4e9069bf8d3d10b2204b1fb8f6ef7065407
      - name: Android lint
        working-directory: bfs-android-app
        run: ./gradlew lint

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
        with:
          version: 9
      - uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: bfs-web-app/pnpm-lock.yaml
      - name: Web type check
        working-directory: bfs-web-app
        run: |
          pnpm install --frozen-lockfile
          pnpm run typecheck

      - uses: actions/setup-go@0a12ed9d6a96ab950c8f026ed9f722fe0da7ef32
        with:
          go-version: '1.25'
      - name: Go vet
        working-directory: bfs-backend
        run: go vet ./...

      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd
      - name: Terraform validate (staging)
        working-directory: bfs-cloud/envs/staging
        run: |
          terraform init -backend=false
          terraform validate

      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd
      - name: Terraform validate (production)
        working-directory: bfs-cloud/envs/production
        run: |
          terraform init -backend=false
          terraform validate

      - name: Set up Java for Android
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165
        with:
          distribution: temurin
          java-version: '21'
      - name: Set up Android SDK
        uses: android-actions/setup-android@9fc6c4e9069bf8d3d10b2204b1fb8f6ef7065407
      - name: Android assemble (debug)
        working-directory: bfs-android-app
        run: ./gradlew assembleDebug

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: typecheck
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
        with:
          version: 9
      - uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: bfs-web-app/pnpm-lock.yaml
      - name: Web tests
        working-directory: bfs-web-app
        run: |
          pnpm install --frozen-lockfile
          pnpm test -- --ci

      - uses: actions/setup-go@0a12ed9d6a96ab950c8f026ed9f722fe0da7ef32
        with:
          go-version: '1.25'
      - name: Go tests
        working-directory: bfs-backend
        run: go test ./...

      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd
      - name: Terraform plan (staging)
        working-directory: bfs-cloud/envs/staging
        run: |
          terraform init -backend=false
          terraform plan

      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd
      - name: Terraform plan (production)
        working-directory: bfs-cloud/envs/production
        run: |
          terraform init -backend=false
          terraform plan

  security:
    name: Vulnerabilities Check
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
        with:
          version: 9
      - uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: bfs-web-app/pnpm-lock.yaml
      - name: Web vuln scan
        working-directory: bfs-web-app
        run: |
          pnpm install --frozen-lockfile
          pnpm audit --audit-level=high || true

      - uses: actions/setup-go@0a12ed9d6a96ab950c8f026ed9f722fe0da7ef32
        with:
          go-version: '1.25'
      - name: Go vuln scan
        working-directory: bfs-backend
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./... || true