name: Deploy Infra via TFC (cloud-only changes)

on:
  push:
    branches: [ staging, production ]
    paths:
      - 'bfs-cloud/**'
      - '.github/workflows/deploy-infra-cloud-changes.yml'

permissions:
  contents: read

concurrency:
  group: deploy-infra-cloud-${{ github.ref }}
  cancel-in-progress: false

jobs:
  changes:
    name: Detect changed areas
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      web: ${{ steps.filter.outputs.web }}
      cloud: ${{ steps.filter.outputs.cloud }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'bfs-backend/**'
            web:
              - 'bfs-web-app/**'
            cloud:
              - 'bfs-cloud/**'

  deploy:
    name: Terraform Cloud apply (cloud-only)
    needs: [changes, validate]
    if: >
      ${{ needs.changes.outputs.cloud == 'true' && needs.changes.outputs.backend != 'true' && needs.changes.outputs.web != 'true' && (github.ref_name == 'staging' || github.ref_name == 'production') }}
    uses: ./.github/workflows/reusable-tfc-apply.yml
    secrets: inherit
    with:
      target_branch: ${{ github.ref_name }}
      image_tag: ${{ github.ref_name }}
      wait_for_completion: ${{ github.ref_name == 'staging' }}

  validate:
    name: Terraform validate (target env)
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.cloud == 'true' }}
    env:
      TF_VERSION: 1.8.5
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Determine env directory
        id: envdir
        shell: bash
        run: |
          case "${{ github.ref_name }}" in
            staging) echo "dir=bfs-cloud/envs/staging" >> $GITHUB_OUTPUT ;;
            production) echo "dir=bfs-cloud/envs/production" >> $GITHUB_OUTPUT ;;
            *) echo "Unsupported branch: ${{ github.ref_name }}" >&2 ; exit 1 ;;
          esac
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      - name: terraform init (-backend=false)
        working-directory: ${{ steps.envdir.outputs.dir }}
        run: terraform init -backend=false
      - name: terraform validate
        working-directory: ${{ steps.envdir.outputs.dir }}
        run: terraform validate
