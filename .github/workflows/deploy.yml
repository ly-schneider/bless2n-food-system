name: Deploy

on:
  workflow_run:
    workflows: ["Build Images"]
    types: [completed]
    branches: [staging, production]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        type: choice
        options: [staging, production]
        required: true
      image_tag:
        description: 'Image tag to deploy (defaults to branch name)'
        type: string
        required: false

permissions:
  contents: read
  actions: read
  deployments: write

concurrency:
  group: deploy-${{ github.event.workflow_run.head_branch || github.event.inputs.environment }}
  cancel-in-progress: false

jobs:
  verify-and-deploy:
    name: Deploy to ${{ github.event.workflow_run.head_branch || github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.workflow_run.head_branch || github.event.inputs.environment }}
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v5.1.0
        with:
          persist-credentials: false
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      # Verify build succeeded (for workflow_run trigger)
      - name: Check build workflow
        if: github.event_name == 'workflow_run'
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "âŒ Build workflow did not succeed"
            exit 1
          fi
          echo "âœ… Build workflow succeeded"

      # Determine environment and workspace
      - name: Set environment variables
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            ENV="${{ github.event.workflow_run.head_branch }}"
            TAG="${{ github.event.workflow_run.head_branch }}"
            SHA="${{ github.event.workflow_run.head_sha }}"
          else
            ENV="${{ github.event.inputs.environment }}"
            TAG="${{ github.event.inputs.image_tag || github.event.inputs.environment }}"
            SHA="${{ github.sha }}"
          fi

          case "$ENV" in
            staging)
              echo "workspace=bfs-staging" >> $GITHUB_OUTPUT
              echo "wait=true" >> $GITHUB_OUTPUT
              ;;
            production)
              echo "workspace=bfs-production" >> $GITHUB_OUTPUT
              echo "wait=false" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "âŒ Unsupported environment: $ENV"
              exit 1
              ;;
          esac

          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "image_tag=$TAG" >> $GITHUB_OUTPUT
          echo "sha=$SHA" >> $GITHUB_OUTPUT

      # Download image digests
      - name: Download image digests
        if: github.event_name == 'workflow_run'
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: build-images.yml
          run_id: ${{ github.event.workflow_run.id }}
          name: image-digests
          path: ./digests
          if_no_artifact_found: warn

      - name: Read digests
        id: digests
        run: |
          BACKEND_DIGEST=""
          FRONTEND_DIGEST=""

          if [ -d "./digests" ]; then
            BACKEND_DIGEST=$(grep -h '^backend=' ./digests/* 2>/dev/null | tail -n1 | cut -d= -f2 || true)
            FRONTEND_DIGEST=$(grep -h '^frontend=' ./digests/* 2>/dev/null | tail -n1 | cut -d= -f2 || true)
          fi

          echo "backend_digest=$BACKEND_DIGEST" >> $GITHUB_OUTPUT
          echo "frontend_digest=$FRONTEND_DIGEST" >> $GITHUB_OUTPUT
          echo "Backend digest: ${BACKEND_DIGEST:-<none>}"
          echo "Frontend digest: ${FRONTEND_DIGEST:-<none>}"

      # Queue Terraform Cloud run
      - name: Trigger Terraform Cloud deployment
        uses: kvrhdn/tfe-run@v1.0.9
        with:
          token: ${{ secrets.TF_API_TOKEN }}
          organization: ${{ vars.TF_ORG_NAME }}
          workspace: ${{ steps.env.outputs.workspace }}
          message: "Deploy ${{ steps.env.outputs.environment }} â€¢ ${{ steps.env.outputs.image_tag }} â€¢ ${{ steps.env.outputs.sha }}"
          wait-for-completion: ${{ steps.env.outputs.wait }}
          tf-vars: |
            image_tag        = "${{ steps.env.outputs.image_tag }}"
            revision_suffix  = "${{ steps.env.outputs.sha }}"
            backend_digest   = "${{ steps.digests.outputs.backend_digest }}"
            frontend_digest  = "${{ steps.digests.outputs.frontend_digest }}"

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ steps.env.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ steps.env.outputs.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Workspace:** ${{ steps.env.outputs.workspace }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment triggered successfully" >> $GITHUB_STEP_SUMMARY
