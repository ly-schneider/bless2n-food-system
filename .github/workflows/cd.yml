name: CD

on:
  workflow_dispatch:
    inputs:
      target_env:
        description: "Environment to deploy to"
        required: true
        type: choice
        options:
          - staging
          - production
      version:
        description: "Semantic version from VERSION file (e.g. 1.0.0-dev)"
        required: true
        type: string
      commit_sha:
        description: "Git commit SHA to build and deploy"
        required: true
        type: string

run-name: "CD | env=${{ inputs.target_env }} | v${{ inputs.version }} | ${{ inputs.commit_sha }}"

jobs:
  resolve-version:
    name: Resolve Version
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.compute.outputs.image_tag }}
      revision_suffix: ${{ steps.compute.outputs.revision_suffix }}
    steps:
      - name: Compute image tag and revision suffix
        id: compute
        env:
          VERSION: ${{ inputs.version }}
          COMMIT_SHA: ${{ inputs.commit_sha }}
          TARGET_ENV: ${{ inputs.target_env }}
        run: |
          SHORT_SHA="${COMMIT_SHA:0:8}"

          if [ "$TARGET_ENV" = "production" ]; then
            IMAGE_TAG="${VERSION%-dev}"
          else
            IMAGE_TAG="$VERSION"
          fi

          SAFE_TAG=$(echo "$IMAGE_TAG" | tr '.' '-')
          REVISION_SUFFIX="${SAFE_TAG}-${SHORT_SHA}"

          echo "image_tag=$IMAGE_TAG" >> "$GITHUB_OUTPUT"
          echo "revision_suffix=$REVISION_SUFFIX" >> "$GITHUB_OUTPUT"

          echo "Image tag: $IMAGE_TAG"
          echo "Revision suffix: $REVISION_SUFFIX"

  build-frontend:
    name: Build Frontend Image
    runs-on: ubuntu-latest
    needs: [resolve-version]
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code at tested commit
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with:
          ref: ${{ inputs.commit_sha }}

      - uses: docker/setup-buildx-action@988b5a0280414f521da01fcc63a27aeeb4b104db
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push Frontend image
        uses: docker/build-push-action@4f58ea79222b3b9dc2c8bbdd6debcef730109a75
        with:
          context: ./bfs-web-app
          file: ./bfs-web-app/Dockerfile
          push: true
          tags: |
            ghcr.io/ly-schneider/bless2n-food-system/frontend:${{ needs.resolve-version.outputs.image_tag }}
            ghcr.io/ly-schneider/bless2n-food-system/frontend:${{ inputs.target_env }}
          cache-from: |
            type=registry,ref=ghcr.io/ly-schneider/bless2n-food-system/frontend:buildcache
            type=registry,ref=ghcr.io/ly-schneider/bless2n-food-system/frontend:${{ inputs.target_env }}
          cache-to: type=registry,ref=ghcr.io/ly-schneider/bless2n-food-system/frontend:buildcache,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            APP_VERSION=${{ needs.resolve-version.outputs.image_tag }}

  build-backend:
    name: Build Backend Image
    runs-on: ubuntu-latest
    needs: [resolve-version]
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code at tested commit
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with:
          ref: ${{ inputs.commit_sha }}

      - uses: docker/setup-buildx-action@988b5a0280414f521da01fcc63a27aeeb4b104db
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push Backend image
        uses: docker/build-push-action@4f58ea79222b3b9dc2c8bbdd6debcef730109a75
        with:
          context: ./bfs-backend
          file: ./bfs-backend/Dockerfile
          push: true
          tags: |
            ghcr.io/ly-schneider/bless2n-food-system/backend:${{ needs.resolve-version.outputs.image_tag }}
            ghcr.io/ly-schneider/bless2n-food-system/backend:${{ inputs.target_env }}
          cache-from: |
            type=registry,ref=ghcr.io/ly-schneider/bless2n-food-system/backend:buildcache
            type=registry,ref=ghcr.io/ly-schneider/bless2n-food-system/backend:${{ inputs.target_env }}
          cache-to: type=registry,ref=ghcr.io/ly-schneider/bless2n-food-system/backend:buildcache,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            APP_VERSION=${{ needs.resolve-version.outputs.image_tag }}

  build-docs:
    name: Build Docs Image
    runs-on: ubuntu-latest
    needs: [resolve-version]
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code at tested commit
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with:
          ref: ${{ inputs.commit_sha }}

      - uses: docker/setup-buildx-action@988b5a0280414f521da01fcc63a27aeeb4b104db
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push Docs image
        uses: docker/build-push-action@4f58ea79222b3b9dc2c8bbdd6debcef730109a75
        with:
          context: ./bfs-docs
          file: ./bfs-docs/Dockerfile
          push: true
          tags: |
            ghcr.io/ly-schneider/bless2n-food-system/docs:${{ needs.resolve-version.outputs.image_tag }}
            ghcr.io/ly-schneider/bless2n-food-system/docs:${{ inputs.target_env }}
          cache-from: |
            type=registry,ref=ghcr.io/ly-schneider/bless2n-food-system/docs:buildcache
            type=registry,ref=ghcr.io/ly-schneider/bless2n-food-system/docs:${{ inputs.target_env }}
          cache-to: type=registry,ref=ghcr.io/ly-schneider/bless2n-food-system/docs:buildcache,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            APP_VERSION=${{ needs.resolve-version.outputs.image_tag }}

  migrate:
    name: Run Migrations
    runs-on: ubuntu-latest
    environment: ${{ inputs.target_env }}
    needs:
      - build-frontend
      - build-backend
      - build-docs
    steps:
      - name: Checkout code at tested commit
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with:
          ref: ${{ inputs.commit_sha }}

      - name: Run Flyway migrations
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/bfs-backend/db/flyway/migrations:/flyway/sql:ro \
            -e FLYWAY_URL="${{ secrets.FLYWAY_URL }}" \
            -e FLYWAY_USER="${{ secrets.FLYWAY_USER }}" \
            -e FLYWAY_PASSWORD="${{ secrets.FLYWAY_PASSWORD }}" \
            flyway/flyway:9-alpine \
            -defaultSchema=app \
            -initSql="SET ROLE app_owner" \
            -baselineOnMigrate=true \
            migrate

  deploy:
    name: Deploy ${{ inputs.target_env }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.target_env }}
    needs:
      - resolve-version
      - migrate
    permissions:
      contents: read
      actions: read

    steps:
      - name: Checkout code at tested commit
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with:
          fetch-depth: 0
          ref: ${{ inputs.commit_sha }}

      - name: Terraform Cloud apply
        uses: kvrhdn/tfe-run@4953a73eaf2b24b7fc7c2a98bc8d112eea1b34c7
        with:
          token: ${{ secrets.TF_API_TOKEN }}
          organization: ${{ vars.TF_ORG_NAME }}
          workspace: ${{ vars.TF_WORKSPACE }}
          message: "CD deploy | env=${{ inputs.target_env }} | v${{ needs.resolve-version.outputs.image_tag }}"
          wait-for-completion: ${{ inputs.target_env == 'staging' }}
          tf-vars: |
            image_tag       = "${{ needs.resolve-version.outputs.image_tag }}"
            revision_suffix = "${{ needs.resolve-version.outputs.revision_suffix }}"
            ghcr_token      = "${{ secrets.GHCR_TOKEN }}"

  git-tag:
    name: Tag Release
    runs-on: ubuntu-latest
    needs: [deploy, resolve-version]
    if: inputs.target_env == 'production'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with:
          ref: ${{ inputs.commit_sha }}

      - name: Create and push git tag
        env:
          IMAGE_TAG: ${{ needs.resolve-version.outputs.image_tag }}
        run: |
          git tag "v${IMAGE_TAG}"
          git push origin "v${IMAGE_TAG}"

  post-release-bump:
    name: Bump to next dev version
    runs-on: ubuntu-latest
    needs: [git-tag, resolve-version]
    if: inputs.target_env == 'production'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with:
          ref: production
          fetch-depth: 0

      - name: Bump patch version
        env:
          RELEASED_TAG: ${{ needs.resolve-version.outputs.image_tag }}
        run: |
          IFS='.' read -r MAJOR MINOR PATCH <<< "$RELEASED_TAG"
          NEXT_PATCH=$((PATCH + 1))
          NEXT_VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}-dev"

          echo "$NEXT_VERSION" > VERSION

          cd bfs-web-app
          ESCAPED=$(echo "$NEXT_VERSION" | sed 's/[&/]/\\&/g')
          sed -i "s/\"version\": \".*\"/\"version\": \"${ESCAPED}\"/" package.json
          cd ..

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add VERSION bfs-web-app/package.json
          git commit -m "chore: bump version to ${NEXT_VERSION} [skip cd]"
          git push origin production

      - name: Fast-forward staging
        run: |
          git fetch origin staging
          git checkout staging
          git merge --ff-only origin/production
          git push origin staging
