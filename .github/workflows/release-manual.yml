name: Release • Manual Tag

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag to create (e.g., v1.2.3)"
        required: true
        type: string
      environment:
        description: "Environment to use for downstream jobs (for env-scoped secrets)"
        required: false
        default: "production"
        type: string
      target:
        description: "Target branch or SHA to tag"
        required: false
        default: "production"
        type: string
      prerelease:
        description: "Mark GitHub release as prerelease"
        required: false
        default: false
        type: boolean
      generate_notes:
        description: "Auto-generate release notes"
        required: false
        default: true
        type: boolean
      dry_run:
        description: "Validate inputs only (no tag/release)"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

concurrency:
  group: manual-release-${{ inputs.version || github.run_id }}
  cancel-in-progress: false

jobs:
  tag-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with:
          fetch-depth: 0

      - name: Validate version input
        id: validate
        run: |
          TAG="${{ inputs.version }}"
          if [ -z "$TAG" ]; then echo "version input is required" >&2; exit 1; fi
          if ! echo "$TAG" | grep -Eq '^v[0-9]+(\.[0-9]+){1,2}([-.][0-9A-Za-z.]+)?$'; then
            echo "Invalid tag format '$TAG'. Expected e.g. v1.2.3" >&2
            exit 1
          fi

      - name: Resolve target commit
        id: resolve
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          tag: ${{ inputs.version }}
          target: ${{ inputs.target }}
          script: |
            const tag = core.getInput('tag');
            const target = core.getInput('target') || 'main';
            const { owner, repo } = context.repo;

            let sha = null;
            if (/^[0-9a-f]{40}$/i.test(target)) {
              sha = target;
            } else {
              // Try heads/<branch>
              try {
                const ref = await github.rest.git.getRef({ owner, repo, ref: target.startsWith('refs/') ? target.replace(/^refs\//,'') : `heads/${target}` });
                sha = ref.data.object.sha;
              } catch (e) {
                // Try tags/<tag>
                try {
                  const ref = await github.rest.git.getRef({ owner, repo, ref: `tags/${target}` });
                  sha = ref.data.object.sha;
                } catch (e2) {}
              }
            }

            if (!sha) {
              core.setFailed(`Could not resolve target '${target}' to a commit SHA.`);
              return;
            }
            core.setOutput('sha', sha);

      - name: Check if tag already exists
        id: exists
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          tag: ${{ inputs.version }}
          script: |
            const tag = core.getInput('tag');
            const { owner, repo } = context.repo;
            let exists = false;
            try {
              await github.rest.git.getRef({ owner, repo, ref: `tags/${tag}` });
              exists = true;
            } catch (e) {}
            core.setOutput('exists', String(exists));
            if (exists) {
              core.setFailed(`Tag '${tag}' already exists.`);
            }

      - name: Dry run summary
        if: ${{ inputs.dry_run == 'true' }}
        run: |
          echo "[DRY RUN] Would create tag '${{ inputs.version }}' at '${{ steps.resolve.outputs.sha }}'"
          echo "           prerelease=${{ inputs.prerelease }} generate_notes=${{ inputs.generate_notes }}"

      - name: Create GitHub Release (creates tag if missing)
        if: ${{ inputs.dry_run != 'true' }}
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          tag: ${{ inputs.version }}
          target: ${{ inputs.target }}
          prerelease: ${{ inputs.prerelease }}
          generate_notes: ${{ inputs.generate_notes }}
          script: |
            const tag = core.getInput('tag');
            const target = core.getInput('target') || 'main';
            const prerelease = core.getInput('prerelease') === 'true';
            const generate = core.getInput('generate_notes') === 'true';
            const { owner, repo } = context.repo;

            // Create release; GitHub will create the tag at target_commitish if it does not exist.
            const rel = await github.rest.repos.createRelease({
              owner,
              repo,
              tag_name: tag,
              target_commitish: target,
              name: tag,
              generate_release_notes: generate,
              prerelease
            });
            core.notice(`Release created: ${rel.data.html_url}`);

      - name: Echo next steps
        run: |
          echo "Tag '${{ inputs.version }}' created."
          echo "Downstream release jobs (e.g., Android) will run on this tag."

  android-release:
    name: Android • Build & Attach
    if: ${{ inputs.dry_run != 'true' }}
    needs: tag-and-release
    uses: ./.github/workflows/release-android.yml
    with:
      tag_name: ${{ inputs.version }}
      environment: ${{ inputs.environment }}
    secrets: inherit
