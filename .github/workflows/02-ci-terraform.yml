name: CI â€¢ Terraform (fmt/validate/plan)

on:
  pull_request:
    branches: [staging, production]
    paths:
      - "bfs-cloud/**"
      - ".github/workflows/02-ci-terraform.yml"
  push:
    branches: [staging, production]
    paths:
      - "bfs-cloud/**"
      - ".github/workflows/02-ci-terraform.yml"

permissions:
  contents: read

jobs:
  fmt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: hashicorp/setup-terraform@v3
        with: { terraform_version: 1.8.5 }
      - name: Terraform fmt (check, recursive)
        working-directory: bfs-cloud
        run: terraform fmt -check -recursive

  discover:
    runs-on: ubuntu-latest
    outputs:
      dirs: ${{ steps.out.outputs.dirs }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - id: out
        shell: bash
        run: |
          BR="${{ github.base_ref || github.ref_name }}"
          BASE="bfs-cloud/envs"
          if [ -d "$BASE/$BR" ]; then
            printf 'dirs=["%s/%s"]\n' "$BASE" "$BR" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          mapfile -t found < <(find "$BASE" -mindepth 1 -maxdepth 1 -type d | sort)
          json="["
          sep=""
          for d in "${found[@]}"; do
            if compgen -G "$d/*.tf" > /dev/null; then
              json+="$sep\"$d\""; sep=","
            fi
          done
          json+="]"
          echo "dirs=$json" >> "$GITHUB_OUTPUT"

  validate:
    needs: [fmt, discover]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        dir: ${{ fromJson(needs.discover.outputs.dirs) }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: hashicorp/setup-terraform@v3
        with: { terraform_version: 1.8.5 }
      - name: terraform init (-backend=false)
        working-directory: ${{ matrix.dir }}
        run: terraform init -backend=false
      - name: terraform validate
        working-directory: ${{ matrix.dir }}
        run: terraform validate

  plan:
    name: Speculative Plan (TFC)
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    env:
      TF_ORG_NAME: ${{ vars.TF_ORG_NAME }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - id: ws
        run: |
          case "${{ github.base_ref }}" in
            staging) echo "workspace=bfs-staging" >> $GITHUB_OUTPUT ;;
            production) echo "workspace=bfs-production" >> $GITHUB_OUTPUT ;;
            *) echo "Unsupported base ref: ${{ github.base_ref }}" ; exit 1 ;;
          esac
      - name: Terraform Cloud Speculative Plan
        uses: kvrhdn/tfe-run@v1
        with:
          token: ${{ secrets.TF_API_TOKEN }}
          organization: ${{ env.TF_ORG_NAME }}
          workspace: ${{ steps.ws.outputs.workspace }}
          message: "Speculative plan for PR #${{ github.event.pull_request.number }}"
          plan-only: true
          wait-for-completion: true
