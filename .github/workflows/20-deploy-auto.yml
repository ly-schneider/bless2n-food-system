name: Deploy â€¢ Auto (after Build)

on:
  workflow_run:
    workflows: ["Build & Push Images"]
    types: [completed]
  push:
    branches: [staging, production]
    paths: [".github/workflows/20-deploy-auto.yml"]

permissions:
  contents: read
  actions: read

concurrency:
  group: deploy-infra-${{ github.event.workflow_run.head_branch || github.ref_name }}
  cancel-in-progress: false

jobs:
  preflight:
    if: >
      ${{
        (github.event_name == 'workflow_run' &&
         github.event.workflow_run.conclusion == 'success' &&
         (github.event.workflow_run.head_branch == 'staging' || github.event.workflow_run.head_branch == 'production')) ||
        (github.event_name == 'push' &&
         (github.ref_name == 'staging' || github.ref_name == 'production'))
      }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v5
        with: { fetch-depth: 0 }

      - name: Determine env dir
        id: envdir
        shell: bash
        run: |
          # Use workflow_run head_branch if available, otherwise fall back to ref_name
          BRANCH="${{ github.event.workflow_run.head_branch || github.ref_name }}"
          case "$BRANCH" in
            staging)   echo "dir=bfs-cloud/envs/staging"   >> $GITHUB_OUTPUT ;;
            production) echo "dir=bfs-cloud/envs/production" >> $GITHUB_OUTPUT ;;
            *) echo "Unsupported env: $BRANCH (workflow_run.head_branch='${{ github.event.workflow_run.head_branch }}', ref_name='${{ github.ref_name }}')" ; exit 1 ;;
          esac

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with: { terraform_version: 1.13.3 }

      - name: terraform validate (no backend)
        working-directory: ${{ steps.envdir.outputs.dir }}
        run: |
          terraform init -backend=false
          terraform validate

  from-build:
    name: Reusable TFC apply (after Build)
    needs: preflight
    if: ${{ needs.preflight.result == 'success' }}
    uses: ./.github/workflows/reusable-tfc-apply.yml
    secrets: inherit
    with:
      target_branch: ${{ github.event.workflow_run.head_branch || github.ref_name }}
      image_tag: ${{ github.event.workflow_run.head_branch || github.ref_name }}
      revision_suffix: ${{ github.event.workflow_run.head_sha || github.sha }}
      wait_for_completion: ${{ (github.event.workflow_run.head_branch || github.ref_name) == 'staging' }}

  on-self-change:
    if: ${{ github.event_name == 'push' }}
    uses: ./.github/workflows/reusable-tfc-apply.yml
    secrets: inherit
    with:
      target_branch: ${{ github.ref_name }}
      image_tag: ${{ github.ref_name }}
      revision_suffix: ${{ github.sha }}
      wait_for_completion: ${{ github.ref_name == 'staging' }}
