name: CI â€¢ Terraform Validate

on:
  pull_request:
    branches: [staging, production]
    paths:
      - 'bfs-cloud/**'
      - '.github/workflows/terraform-validate.yml'
  push:
    branches: [staging, production]
    paths:
      - 'bfs-cloud/**'
      - '.github/workflows/terraform-validate.yml'

permissions:
  contents: read

jobs:
  fmt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: hashicorp/setup-terraform@v3
        with: { terraform_version: 1.8.5 }
      - name: Terraform fmt (check, recursive)
        run: terraform fmt -check -recursive

  discover:
    runs-on: ubuntu-latest
    outputs:
      dirs: ${{ steps.out.outputs.dirs }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - id: out
        shell: bash
        run: |
          BR="${{ github.base_ref || github.ref_name }}"
          BASE="bfs-cloud/envs"
          if [ -d "$BASE/$BR" ]; then
            printf 'dirs=["%s/%s"]\n' "$BASE" "$BR" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          mapfile -t found < <(find "$BASE" -mindepth 1 -maxdepth 1 -type d | sort)
          json="["
          sep=""
          for d in "${found[@]}"; do
            if compgen -G "$d/*.tf" > /dev/null; then
              json+="$sep\"$d\""; sep=","
            fi
          done
          json+="]"
          echo "dirs=$json" >> "$GITHUB_OUTPUT"

  validate:
    needs: [fmt, discover]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        dir: ${{ fromJson(needs.discover.outputs.dirs) }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: hashicorp/setup-terraform@v3
        with: { terraform_version: 1.8.5 }
      - name: terraform init (-backend=false)
        working-directory: ${{ matrix.dir }}
        run: terraform init -backend=false
      - name: terraform validate
        working-directory: ${{ matrix.dir }}
        run: terraform validate

  gate:
    needs: [fmt, validate]
    runs-on: ubuntu-latest
    if: ${{ always() }}
    steps:
      - name: Summarize results
        run: |
          echo "Terraform fmt: ${{ needs.fmt.result }}" >> $GITHUB_STEP_SUMMARY
          echo "Terraform validate: ${{ needs.validate.result }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.fmt.result }}" != "success" ] || [ "${{ needs.validate.result }}" != "success" ]; then
            echo "One or more Terraform checks failed." >&2
            exit 1
          fi
