name: Deploy Canary

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy'
        required: true
        type: string
      skip_validation:
        description: 'Skip post-deploy validation'
        type: boolean
        default: false

permissions:
  contents: read
  deployments: write
  issues: write

concurrency:
  group: deploy-canary-production
  cancel-in-progress: false

jobs:
  canary-deploy:
    name: Canary deployment to production
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with:
          persist-credentials: false

      - name: Azure Login
        uses: azure/login@6c251865b4e6290e7b78be643ea2d005bc51f69a
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set variables
        id: vars
        run: |
          echo "resource_group=bfs-production" >> $GITHUB_OUTPUT
          echo "backend_app=bfs-backend" >> $GITHUB_OUTPUT
          echo "frontend_app=bfs-frontend" >> $GITHUB_OUTPUT
          echo "canary_suffix=canary-${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: Deploy backend canary revision
        id: backend-canary
        run: |
          az containerapp revision copy \
            --name ${{ steps.vars.outputs.backend_app }} \
            --resource-group ${{ steps.vars.outputs.resource_group }} \
            --revision-suffix ${{ steps.vars.outputs.canary_suffix }} \
            --image ghcr.io/${{ github.repository }}/backend:${{ inputs.image_tag }}

          # Set traffic split: 10% to canary, 90% to stable
          az containerapp ingress traffic set \
            --name ${{ steps.vars.outputs.backend_app }} \
            --resource-group ${{ steps.vars.outputs.resource_group }} \
            --revision-weight latest=10 stable=90

          echo "âœ… Backend canary deployed with 10% traffic"

      - name: Deploy frontend canary revision
        id: frontend-canary
        run: |
          az containerapp revision copy \
            --name ${{ steps.vars.outputs.frontend_app }} \
            --resource-group ${{ steps.vars.outputs.resource_group }} \
            --revision-suffix ${{ steps.vars.outputs.canary_suffix }} \
            --image ghcr.io/${{ github.repository }}/frontend:${{ inputs.image_tag }}

          # Set traffic split: 10% to canary, 90% to stable
          az containerapp ingress traffic set \
            --name ${{ steps.vars.outputs.frontend_app }} \
            --resource-group ${{ steps.vars.outputs.resource_group }} \
            --revision-weight latest=10 stable=90

          echo "âœ… Frontend canary deployed with 10% traffic"

      - name: Monitor canary (10% traffic)
        run: |
          echo "Monitoring canary at 10% traffic for 10 minutes..."

          for i in {1..20}; do
            echo "Check $i/20..."

            # Basic health check
            BACKEND_STATUS=$(az containerapp revision show \
              --name ${{ steps.vars.outputs.backend_app }} \
              --resource-group ${{ steps.vars.outputs.resource_group }} \
              --revision ${{ steps.vars.outputs.backend_app }}--${{ steps.vars.outputs.canary_suffix }} \
              --query "properties.healthState" -o tsv)

            FRONTEND_STATUS=$(az containerapp revision show \
              --name ${{ steps.vars.outputs.frontend_app }} \
              --resource-group ${{ steps.vars.outputs.resource_group }} \
              --revision ${{ steps.vars.outputs.frontend_app }}--${{ steps.vars.outputs.canary_suffix }} \
              --query "properties.healthState" -o tsv)

            echo "Backend health: $BACKEND_STATUS"
            echo "Frontend health: $FRONTEND_STATUS"

            if [ "$BACKEND_STATUS" != "Healthy" ] || [ "$FRONTEND_STATUS" != "Healthy" ]; then
              echo "âŒ Canary unhealthy, rolling back"
              exit 1
            fi

            sleep 30
          done

          echo "âœ… Canary healthy at 10% traffic"

      - name: Promote canary to 50%
        run: |
          az containerapp ingress traffic set \
            --name ${{ steps.vars.outputs.backend_app }} \
            --resource-group ${{ steps.vars.outputs.resource_group }} \
            --revision-weight latest=50 stable=50

          az containerapp ingress traffic set \
            --name ${{ steps.vars.outputs.frontend_app }} \
            --resource-group ${{ steps.vars.outputs.resource_group }} \
            --revision-weight latest=50 stable=50

          echo "âœ… Canary promoted to 50% traffic"

      - name: Monitor canary (50% traffic)
        run: |
          echo "Monitoring canary at 50% traffic for 10 minutes..."
          sleep 600
          echo "âœ… Canary stable at 50% traffic"

      - name: Promote canary to 100%
        run: |
          az containerapp ingress traffic set \
            --name ${{ steps.vars.outputs.backend_app }} \
            --resource-group ${{ steps.vars.outputs.resource_group }} \
            --revision-weight latest=100

          az containerapp ingress traffic set \
            --name ${{ steps.vars.outputs.frontend_app }} \
            --resource-group ${{ steps.vars.outputs.resource_group }} \
            --revision-weight latest=100

          echo "âœ… Canary promoted to 100% traffic"

      - name: Run smoke tests
        if: inputs.skip_validation != true
        run: |
          # Basic health checks
          curl -f https://api.bless2n.app/health || exit 1
          curl -f https://bless2n.app || exit 1
          echo "âœ… Smoke tests passed"

      - name: Rollback on failure
        if: failure()
        run: |
          echo "âŒ Canary deployment failed, rolling back"

          # Revert traffic to stable
          az containerapp ingress traffic set \
            --name ${{ steps.vars.outputs.backend_app }} \
            --resource-group ${{ steps.vars.outputs.resource_group }} \
            --revision-weight stable=100

          az containerapp ingress traffic set \
            --name ${{ steps.vars.outputs.frontend_app }} \
            --resource-group ${{ steps.vars.outputs.resource_group }} \
            --revision-weight stable=100

          # Deactivate canary revisions
          az containerapp revision deactivate \
            --name ${{ steps.vars.outputs.backend_app }} \
            --resource-group ${{ steps.vars.outputs.resource_group }} \
            --revision ${{ steps.vars.outputs.backend_app }}--${{ steps.vars.outputs.canary_suffix }}

          az containerapp revision deactivate \
            --name ${{ steps.vars.outputs.frontend_app }} \
            --resource-group ${{ steps.vars.outputs.resource_group }} \
            --revision ${{ steps.vars.outputs.frontend_app }}--${{ steps.vars.outputs.canary_suffix }}

          echo "âœ… Rollback complete"

      - name: Create incident issue
        if: failure()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Canary Deployment Failed and Rolled Back',
              body: `Canary deployment to production failed and was automatically rolled back.

              **Details:**
              - Image Tag: ${{ inputs.image_tag }}
              - Run: ${context.payload.repository.html_url}/actions/runs/${context.runId}
              - Time: ${new Date().toISOString()}

              Please investigate the failure before attempting another deployment.`,
              labels: ['incident', 'deployment', 'production']
            });

      - name: Deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Canary Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Canary Suffix:** ${{ steps.vars.outputs.canary_suffix }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Canary deployment successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Canary deployment failed and rolled back" >> $GITHUB_STEP_SUMMARY
          fi
