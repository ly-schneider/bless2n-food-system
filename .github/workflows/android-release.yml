name: Android Release

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to build for'
        required: true
        type: choice
        options:
          - staging
          - production
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  quality-checks:
    name: Android Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Set up Java
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup Android SDK
        uses: android-actions/setup-android@9fc6c4e9069bf8d3d10b2204b1fb8f6ef7065407

      - name: Setup Gradle cache
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2
        with:
          cache-read-only: false

      - name: Lint
        working-directory: bfs-android-app
        run: ./gradlew lint --parallel

      - name: Run tests
        working-directory: bfs-android-app
        run: ./gradlew test --parallel

      - name: Assemble debug
        working-directory: bfs-android-app
        run: ./gradlew assembleDebug --parallel

  build-and-release:
    name: Build & Release Android APK
    runs-on: ubuntu-latest
    needs: quality-checks
    environment: ${{ inputs.environment }}
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Set up Java
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165
        with:
          distribution: temurin
          java-version: "21"

      - name: Set up Android SDK
        uses: android-actions/setup-android@9fc6c4e9069bf8d3d10b2204b1fb8f6ef7065407

      - name: Setup Gradle cache
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2
        with:
          cache-read-only: false

      - name: Decode keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo -n "$ANDROID_KEYSTORE_BASE64" | base64 -d > "$RUNNER_TEMP/upload-keystore.jks"
          echo "BFS_UPLOAD_STORE_FILE=$RUNNER_TEMP/upload-keystore.jks" >> "$GITHUB_ENV"

      - name: Validate version format
        id: version
        run: |
          VERSION="${{ inputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format X.Y.Z (e.g., 1.0.0)"
            exit 1
          fi

          # Calculate version code (major * 10000 + minor * 100 + patch)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          VERSION_CODE=$((MAJOR * 10000 + MINOR * 100 + PATCH))

          echo "version_name=$VERSION" >> "$GITHUB_OUTPUT"
          echo "version_code=$VERSION_CODE" >> "$GITHUB_OUTPUT"
          echo "date=$(date +'%Y-%m-%d %H:%M:%S')" >> "$GITHUB_OUTPUT"

      - name: Build Android release APK
        working-directory: bfs-android-app
        env:
          VERSION_TAG: ${{ inputs.version }}
          SUMUP_AFFILIATE_KEY: ${{ secrets.SUMUP_AFFILIATE_KEY }}
          POS_URL: ${{ secrets.POS_URL }}
          ORG_GRADLE_PROJECT_sumupAffiliateKey: ${{ secrets.SUMUP_AFFILIATE_KEY }}
          ORG_GRADLE_PROJECT_posUrl: ${{ secrets.POS_URL }}
          ORG_GRADLE_PROJECT_bfsEnv: ${{ inputs.environment }}
          BFS_UPLOAD_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          BFS_UPLOAD_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          BFS_UPLOAD_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_ALIAS_PASSWORD }}
        run: |
          ./gradlew clean assembleRelease

      - name: Rename APK with environment
        run: |
          cd bfs-android-app/app/build/outputs/apk/release
          for apk in *.apk; do
            mv "$apk" "bfs-pos-${{ inputs.environment }}-v${{ inputs.version }}.apk"
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@6da8fa9354ddfdc4aeace5fc48d7f679b5214090
        with:
          tag_name: android-${{ inputs.environment }}-v${{ inputs.version }}
          name: Android POS - ${{ inputs.environment }} v${{ inputs.version }}
          body: |
            ## Android POS Release

            **Environment:** ${{ inputs.environment }}
            **Version:** ${{ inputs.version }} (build ${{ steps.version.version_code }})
            **Built:** ${{ steps.version.date }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}

            ---

            Download the APK below and install on your tablets.
          draft: false
          prerelease: ${{ inputs.environment == 'staging' }}
          files: |
            bfs-android-app/app/build/outputs/apk/release/*.apk

      - name: Build summary
        run: |
          echo "## Android Release Created âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ inputs.version }} (build ${{ steps.version.version_code }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** android-${{ inputs.environment }}-v${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **APK:** bfs-pos-${{ inputs.environment }}-v${{ inputs.version }}.apk" >> $GITHUB_STEP_SUMMARY
          echo "- **Prerelease:** ${{ inputs.environment == 'staging' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "APK is available in the [Releases](https://github.com/${{ github.repository }}/releases) page." >> $GITHUB_STEP_SUMMARY
