name: Android Release

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Tag to create or reuse (e.g., v1.2.3)"
        required: false
      upload_to_s3:
        description: "Also upload to S3 (requires AWS secrets)"
        required: false
        default: "false"
  push:
    tags:
      - "v*"

permissions:
  contents: write  # needed for creating releases

jobs:
  build-release:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: bfs-android-app
    env:
      # Required by the app for release builds
      SUMUP_AFFILIATE_KEY: ${{ secrets.SUMUP_AFFILIATE_KEY }}
      POS_URL_RELEASE: ${{ secrets.POS_URL_RELEASE }}
      # Optional: signing via env (preferred) or Gradle properties
      BFS_UPLOAD_STORE_FILE: ${{ github.workspace }}/bfs-android-app/upload-keystore.jks
      BFS_UPLOAD_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      BFS_UPLOAD_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      BFS_UPLOAD_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_ALIAS_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 35
          build-tools: 35.0.0

      - name: Decode upload keystore
        if: secrets.ANDROID_KEYSTORE_BASE64 != ''
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > upload-keystore.jks

      - name: Configure local.properties
        run: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties

      - name: Build Signed Release APK
        run: |
          ./gradlew --no-daemon clean :app:assembleRelease \
            -PsumupAffiliateKey="$SUMUP_AFFILIATE_KEY" \
            -PposUrlRelease="$POS_URL_RELEASE"

      - name: Build Release AAB
        run: |
          ./gradlew --no-daemon :app:bundleRelease \
            -PsumupAffiliateKey="$SUMUP_AFFILIATE_KEY" \
            -PposUrlRelease="$POS_URL_RELEASE"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release-outputs
          path: |
            bfs-android-app/app/build/outputs/apk/release/*.apk
            bfs-android-app/app/build/outputs/bundle/release/*.aab

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag || github.ref_name || 'untagged' }}
          generate_release_notes: true
          files: |
            bfs-android-app/app/build/outputs/apk/release/*.apk
            bfs-android-app/app/build/outputs/bundle/release/*.aab

      - name: Upload to S3 (optional)
        if: ${{ github.event.inputs.upload_to_s3 == 'true' }}
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
        run: |
          pipx install awscli || pip install --user awscli
          VERSION_TAG="${{ github.event.inputs.release_tag || github.ref_name }}"
          APK_PATH=$(ls app/build/outputs/apk/release/*.apk | head -n1)
          AAB_PATH=$(ls app/build/outputs/bundle/release/*.aab | head -n1)
          aws s3 cp "$APK_PATH" "s3://$S3_BUCKET/android/releases/$VERSION_TAG/app-release.apk" --acl public-read
          aws s3 cp "$AAB_PATH" "s3://$S3_BUCKET/android/releases/$VERSION_TAG/app-release.aab" --acl public-read
          # Also publish/overwrite latest
          aws s3 cp "$APK_PATH" "s3://$S3_BUCKET/android/latest/app-release.apk" --acl public-read
          aws s3 cp "$AAB_PATH" "s3://$S3_BUCKET/android/latest/app-release.aab" --acl public-read

