make_order Edge Function

Description

This JSON structure represents a request for creating a new order in the POS system. The frontend will send this payload to the backend, where the order will be processed and saved in the database. The structure contains key information about the order, such as the user, donation, total amount, any applicable discounts, and the list of items being purchased.

Request URL

https://vykrkekwtijhkuwgvtbj.supabase.co/functions/v1/make_order

Method: POST

Request Json

{
  "user_id": "string",
  "donation_amount": "number",
  "total_amount": "number",
  "discount_code": "string",
  "payment_method": "string",
  "items": [
    {
      "item_id": "string",
      "quantity": "number"
    }
  ]
}


Example json

{
  "user_id": "464ae981-cb34-4d05-a7b8-9a298804e341",
  "donation_amount": 5.00,
  "total_amount": 31.00,
  "discount_code": "",
  "payment_method":"TWI",
  "items": [
    {
      "item_id": "5e92a806-7eed-448d-9c18-df3526ba97ee",
      "quantity": 2
    },
    {
      "item_id": "09eb247a-5a58-465e-b5ac-9eb92bed44d0",
      "quantity": 1
    },
    {
      "item_id": "686914ef-ba67-48a8-b68e-75f8656824ea",
      "quantity": 1
    }
  ]
}



Field Explanations:

1. user_id (UUID, Required)





Description: This is the unique identifier of the user placing the order, represented as a UUID.



Example: "b3f4a7d4-0e95-4cbf-8e44-56e6fb70c5ef"

2. donation_amount (Numeric, Optional)





Description: Specifies any additional donation amount added by the user during checkout.



Example: 5.00



Default: If not provided, the default value is 0.



Notes: This field allows users to contribute an extra amount that can be designated for charity or another cause.

3. total_amount (Numeric, Required)





Description: The total monetary value of the order, which includes the cost of all items, taxes, fees, donations and discounts.



Example: 75.00



Notes: This field is mandatory and must represent the total value of the order to ensure the backend calculates and stores the correct amount.

4. discount_code (String, Optional)





Description: A promotional or discount code that can be applied to the order for a price reduction.



Example: "SUMMER2024"



Default: An empty string ("") if no discount is applied.



Notes: If this field is populated with a valid code, the backend should validate it and apply any corresponding discount.

5. payment_method (String, Required)





Description: he payment_method field indicates the method used for processing the payment for the order. 



Example: "TWI"



Notes: It has to be the 3 digit code “payment_code” from the “payment_method” table. In the moment there are these options: 





Cash: CSH



Credit Card: CRE



TWINT: TWI

6. items (Array of Objects, Required)





Description: An array that contains the list of items being purchased in the order. Each object in the array represents a specific item and its quantity. This can be either a product or menu. If it is a menu, the products within the menu don’t have to be clarified.

Each object in the items array has the following fields:





item_id (UUID, Required): The unique identifier for the item being purchased.





Example: "a89c7a31-789c-4e64-a86f-f0b8aaf097d1"



Notes: This value must correspond to an existing item_id in the Item table.



quantity (Integer, Required): The number of units of this item being ordered.





Example: 2



Notes: The quantity should be validated to ensure there is sufficient stock for the requested amount.



Response

Overview







Response Code



Description





200



Order created successfully.





400



Bad Request - The request could not be understood.









Missing user_id - The user_id field is required.









Missing or invalid total_amount - Must be a positive number.









Invalid donation_amount - Must be a non-negative number.









Missing items array or it is empty - Items are required.









Missing payment method - Payment method is required.









Missing item_id for item at index X - Item is missing an ID.









Invalid quantity for item at index X - Quantity must be positive.









Invalid payment method or not found - Payment method does not exist.









Invalid items or stock error - Item validation failed.









Insufficient stock for item X - Requested quantity exceeds stock.









Invalid or expired discount code - Discount code is invalid.









Discount code is not valid at this time - Not valid based on current date.









Total amount does not match calculated total - Total discrepancies.









Failed to fetch status for order fulfillment - Could not retrieve order status.









Failed to create order - General error during order creation.









Failed to create order lines - Error inserting order items.









Failed to fetch item stock - Could not retrieve stock information.









Failed to update stock - Error occurred while updating stock.









Item with ID X not found or invalid - Invalid item ID.









Failed to insert fulfillment record for item X - Error inserting fulfillment record.





500



Internal Server Error - An unexpected error occurred.



The function can return several different responses based on the request's outcome. Below are the possible responses:

1. Success Response





Status Code: 200 OK



Content-Type: application/json



Body:

{ "message": "Order created successfully", "order_id": "string" // The ID of the newly created order }

2. Client Error Responses

These responses indicate issues with the request made by the client. The following errors can occur:





Status Code: 400 Bad Request





Body:

{ "error": "Missing user_id" }





Description: This error occurs if the user_id is not provided in the request.



Status Code: 400 Bad Request





Body:

{ "error": "Missing or invalid total_amount" }





Description: This error occurs if total_amount is not provided, is not a number, or is less than or equal to zero.



Status Code: 400 Bad Request





Body:

{ "error": "Invalid donation_amount, it should be a positive number or zero" }





Description: This error occurs if donation_amount is provided but is negative.



Status Code: 400 Bad Request





Body:

{ "error": "Missing items array or it is empty" }





Description: This error occurs if the items array is not provided or is empty.



Status Code: 400 Bad Request





Body:

{ "error": "Missing payment method." }





Description: This error occurs if payment_method is not provided in the request.



Status Code: 400 Bad Request





Body:

{ "error": "Missing item_id for item at index {index}" }





Description: This error occurs if any item in the items array does not have an item_id.



Status Code: 400 Bad Request





Body:

{ "error": "Invalid quantity for item at index {index}, must be a positive number" }





Description: This error occurs if any item in the items array has an invalid quantity (not a number or less than or equal to zero).



Status Code: 400 Bad Request





Body:

{ "error": "Invalid payment method or not found" }





Description: This error occurs if the provided payment_method does not match any records in the payment_method table.



Status Code: 400 Bad Request





Body:

{ "error": "Invalid items or stock error" }





Description: This error occurs if there is an issue fetching item details or if not all items are found in the items table.



Status Code: 400 Bad Request





Body:

{ "error": "Insufficient stock for item {item_id}" }





Description: This error occurs if an item is requested with a quantity greater than its available stock.



Status Code: 400 Bad Request





Body:

{ "error": "Invalid or expired discount code" }





Description: This error occurs if the provided discount_code does not exist or is invalid.



Status Code: 400 Bad Request





Body:

{ "error": "Discount code is not valid at this time" }





Description: This error occurs if the discount code is outside its valid date range.



Status Code: 400 Bad Request





Body:

{ "error": "Total amount does not match calculated total" }





Description: This error occurs if the calculated final amount does not match the total_amount provided in the request.



Status Code: 400 Bad Request





Body:

{ "error": "Failed to retrieve order line for item {item_id}" }





Description: This error occurs when there is an issue retrieving order line details during the fulfillment process.

3. Server Error Responses

These responses indicate unexpected issues that occur on the server side:





Status Code: 500 Internal Server Error





Body:

{ "error": "Failed to create order", "details": "error details here" }





Description: This error occurs if there is a failure during the order creation process. The details field can provide additional context on the failure.



Status Code: 500 Internal Server Error





Body:

{ "error": "Failed to fetch item stock" }





Description: This error occurs if there is an issue fetching the stock levels for items.



Status Code: 500 Internal Server Error





Body:

{ "error": "Failed to update stock" }





Description: This error occurs if there is an issue updating the stock levels in the item table.



Status Code: 500 Internal Server Error





Body:

{ "error": "Failed to insert fulfillment record for item {item_id}" }





Description: This error occurs when there is an issue inserting fulfillment records into the order_fulfillment table.