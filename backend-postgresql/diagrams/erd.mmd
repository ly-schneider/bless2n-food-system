erDiagram
    roles {
        integer id PK "not null"
        text name UK "not null"
        text display_name "not null"
        text description
        boolean is_default "default false not null"
        boolean is_active  "default true not null"
        timestamptz created_at "default now() not null"
    }

    users {
        nano_id id PK "not null"
        text first_name "not null"
        text last_name  "not null"
        text email      UK "not null"
        argon2_hash password_hash "not null --argon2"
        boolean is_verified  "default false not null"
        boolean is_disabled  "default false not null"
        text disabled_reason
        integer role_id FK "not null"
        timestamptz created_at "default now() not null"
        timestamptz updated_at
    }

    verification_tokens {
        nano_id user_id FK   "not null"
        argon2_hash token_hash "not null --argon2"
        timestamptz expires_at "not null"
    }

    password_reset_tokens {
        nano_id user_id FK   "not null"
        argon2_hash token_hash "not null --argon2"
        timestamptz expires_at "not null"
    }

    refresh_tokens {
        nano_id user_id FK   "not null"
        argon2_hash token_hash "not null --argon2"
        timestamptz issued_at  "default now() not null"
        timestamptz expires_at "not null"
        boolean is_revoked "default false not null"
    }

    audit_logs {
        integer id PK "not null"
        nano_id user_id FK "not null"
        inet public_ip      "not null"
        text event   "not null"
        timestamptz created_at "default now() not null"
    }

    events {
        nano_id id PK "not null"
        nano_id owner_id FK  "not null"
        text name           "not null"
        integer checkout_spots "not null check (checkout_spots >= 0)"
        text location       "not null"
        boolean is_self_checkout "default false not null"
        date start_date
        date end_date
        timestamptz created_at "default now() not null"
        timestamptz updated_at
    }

    event_roles {
        integer id PK "not null"
        text name         "not null"
        text display_name "not null"
        text description
        boolean is_default "default false not null"
        boolean is_active  "default true not null"
        timestamptz created_at "default now() not null"
    }

    event_users {
        nano_id event_id FK "not null"
        nano_id user_id  FK "not null"
        integer event_role_id FK "not null"
        timestamptz invited_at "default now() not null"
        timestamptz joined_at
    }

    event_invites {
        nano_id id PK "not null"
        nano_id event_id FK "not null"
        integer event_role_id FK "not null"
        text invitee_email "not null"
        timestamptz expires_at "not null"
    }

    devices {
        nano_id id PK "not null"
        text serial_number UK "not null"
        text model "not null"
        boolean is_active "default true not null"
        timestamptz created_at "default now() not null"
        timestamptz updated_at
    }

    event_devices {
        nano_id id PK "not null"
        nano_id event_id FK  "not null"
        nano_id device_id FK "not null"
        timestamptz assigned_at "default now() not null"
    }

    device_pairings {
        nano_id id PK "not null"
        nano_id event_device_id FK  "not null"
        device_pairing_role_enum role "not null"
        timestamptz created_at "default now() not null"
        timestamptz updated_at
    }

    event_categories {
        nano_id id PK "not null"
        nano_id event_id FK "not null"
        varchar(20) name  "not null"
        text emoji "not null"
        boolean is_active "default true not null"
        timestamptz created_at "default now() not null"
        timestamptz updated_at
    }

    event_products {
        nano_id id PK "not null"
        nano_id event_id FK    "not null"
        nano_id event_category_id FK "not null"
        varchar(30) name   "not null"
        text emoji  "not null"
        numeric price "not null check (price > 0) -- numeric(6,2)"
        boolean is_active "default true not null"
        timestamptz created_at "default now() not null"
        timestamptz updated_at
    }

    customer_orders {
        nano_id id PK "not null"
        nano_id event_id  FK "not null"
        nano_id event_device_id FK "not null"
        numeric total "not null check (total >= 0) -- numeric(6,2)"
        order_status status "not null"
        timestamptz created_at "default now() not null"
        timestamptz updated_at
    }

    customer_order_items {
        nano_id customer_order_id   FK "not null"
        nano_id event_product_id FK "not null"
        integer quantity "not null check (quantity > 0)"
        numeric price_per_unit "not null check (price_per_unit > 0) -- numeric(6,2)"
    }

    %% relationships
    roles               ||--o{ users                 : has
    users               ||--o{ verification_tokens   : issues
    users               ||--o{ password_reset_tokens : issues
    users               ||--o{ refresh_tokens        : issues
    users               ||--o{ audit_logs            : generates
    users               ||--o{ events                : owns
    events              ||--o{ event_users           : contains
    users               ||--o{ event_users           : participates_in
    event_roles         ||--o{ event_users           : assigns
    events              ||--o{ event_invites         : sends
    event_roles         ||--o{ event_invites         : for_role
    devices             ||--o{ event_devices         : is_assigned_in
    events              ||--o{ event_devices         : uses
    event_devices       ||--o{ device_pairings       : pairs
    events              ||--o{ event_categories      : categorizes
    event_categories    ||--o{ event_products        : includes
    event_products      ||--o{ customer_order_items  : ordered_in
    customer_orders     ||--o{ customer_order_items  : contains
    events              ||--o{ customer_orders       : receives
    event_devices       ||--o{ customer_orders       : processes