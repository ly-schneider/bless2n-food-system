name: bless2n-food-system

services:
  mongo:
    image: mongo:8
    restart: unless-stopped
    ports:
      - "${MONGO_PORT:-27017}:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-change-me-strong}
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'mongosh "mongodb://$${MONGO_INITDB_ROOT_USERNAME}:$${MONGO_INITDB_ROOT_PASSWORD}@localhost:27017/admin" --quiet --eval "db.adminCommand(''ping'').ok" | grep -q 1',
        ]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 5s

  mailpit:
    image: axllent/mailpit:latest
    restart: unless-stopped
    ports:
      - "8025:8025" # UI
      - "1025:1025" # SMTP
    environment:
      MP_MAX_MESSAGES: 5000
      MP_SMTP_AUTH_ACCEPT_ANY: "1"
      MP_SMTP_AUTH_ALLOW_INSECURE: "1"

  mongo-express:
    image: mongo-express:1.0.2-20-alpine3.19
    restart: unless-stopped
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_URL: "mongodb://${MONGO_ROOT_USERNAME:-admin}:${MONGO_ROOT_PASSWORD:-change-me-strong}@mongo:27017/?authSource=admin"
      ME_CONFIG_BASICAUTH_ENABLED: "true"
      ME_CONFIG_BASICAUTH_USERNAME: ${MONGOEXPRESS_BASIC_USER:-me-admin}
      ME_CONFIG_BASICAUTH_PASSWORD: ${MONGOEXPRESS_BASIC_PASSWORD:-also-change-me}
    depends_on:
      - mongo

  backend:
    build:
      context: ./bfs-backend
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      mongo:
        condition: service_healthy
      mailpit:
        condition: service_started
    ports:
      - "${APP_PORT:-8080}:8080"
    env_file:
      - bfs-backend/.env
    environment:
      ALLOW_DOTENV_IN_DOCKER: "true"

    volumes:
      - ./bfs-backend/.env:/app/.env:ro
      - ./bfs-backend/secrets/dev:/app/secrets/dev:ro

  web-app:
    build:
      context: ./bfs-web-app
      dockerfile: docker/Dockerfile
      args:
        NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL}
        BACKEND_INTERNAL_URL: ${BACKEND_INTERNAL_URL}
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_started
    ports:
      - "3000:3000"
    environment:
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL}
      BACKEND_INTERNAL_URL: ${BACKEND_INTERNAL_URL}

volumes:
  mongo_data:
