name: bfs-backend

services:
  mailpit:
    image: axllent/mailpit:latest
    restart: unless-stopped
    ports:
      - "8025:8025"
      - "1025:1025"
    environment:
      MP_MAX_MESSAGES: 5000
      MP_SMTP_AUTH_ACCEPT_ANY: "1"
      MP_SMTP_AUTH_ALLOW_INSECURE: "1"

  mongo:
    image: mongo:8
    restart: always
    ports:
      - "${MONGO_PORT:-27017}:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}

  mongo-express:
    image: mongo-express:1.0.2-20-alpine3.19
    restart: always
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_URL: "${MONGO_URI_DOCKER}"
      ME_CONFIG_BASICAUTH_ENABLED: "true"
      ME_CONFIG_BASICAUTH_USERNAME: ${MONGOEXPRESS_BASIC_USER}
      ME_CONFIG_BASICAUTH_PASSWORD: ${MONGOEXPRESS_BASIC_PASSWORD}
    depends_on:
      - mongo

  backend:
    profiles: ["backend"]
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      mongo:
        condition: service_healthy
      mongo-express:
        condition: service_healthy
      mailpit:
        condition: service_healthy
    restart: unless-stopped
    ports:
      - "${APP_PORT}:8080"
    environment:
      APP_ENV: ${APP_ENV}
      APP_PORT: ${APP_PORT}
      LOG_LEVEL: ${LOG_LEVEL}
      LOG_DEVELOPMENT: ${LOG_DEVELOPMENT}

      MONGO_URI: ${MONGO_URI}
      JWT_SECRET: ${JWT_SECRET}
      MONGO_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
      MONGO_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}

      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USERNAME: ${SMTP_USERNAME}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_FROM: ${SMTP_FROM}
      SMTP_TLS_POLICY: ${SMTP_TLS_POLICY}
